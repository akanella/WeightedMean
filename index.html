<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
    <title data-translate="Weighted Mean">Weighted Mean</title>
    <script src="js/popper.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.2/css/flag-icons.min.css" rel="stylesheet">
    <script src="js/bootstrap.min.js"></script>
    <script src="js/translation.js"></script>
    <script src="js/chart.min.js"></script>
    <link rel="icon" href="average.png" sizes="16x16" type="image/png">
</head>

<style>
    table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

    td,
    th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
    }
</style>

<body style="padding-bottom: 90px;">
    <div class="row col-12" style="margin-bottom:30px">
        <div class="col-10">
            <b data-translate="Weighted Mean Calculator">Weighted Mean Calculator</b>
            <span>v. 1.7</span>
            <span> | </span>
            <span><a href="info.html">info</a></span>
        </div>
        <div class="col-2">
            <div class="dropdown text-center">
                <a class="btn btn-link dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                    <span class="translatable translate-eng"><span class="fi fi-gb fig"></span> english</span>
                    <span class="translatable translate-fr"><span class="fi fi-fr fig"></span> français</span>
                    <span class="translatable translate-de"><span class="fi fi-de fig"></span> deutsch</span>
                    <span class="translatable translate-es"><span class="fi fi-es fig"></span> español</span>
                    <span class="translatable translate-pt"><span class="fi fi-pt fig"></span> português</span>
                    <span class="translatable translate-gr"><span class="fi fi-gr fig"></span> ελληνικά</span>
                </a>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a style="cursor:pointer" class="dropdown-item languages text-center" data-lang="eng"> <span
                            class="fi fi-gb fig"></span> english </a>
                    <a style="cursor:pointer" class="dropdown-item languages text-center" data-lang="fr"> <span
                            class="fi fi-fr fig"></span> français </a>
                    <a style="cursor:pointer" class="dropdown-item languages text-center" data-lang="de"> <span
                            class="fi fi-de fig"></span> deutsch </a>
                    <a style="cursor:pointer" class="dropdown-item languages text-center" data-lang="es"> <span
                            class="fi fi-es fig"></span> español </a>
                    <a style="cursor:pointer" class="dropdown-item languages text-center" data-lang="pt"> <span
                            class="fi fi-pt fig"></span> português </a>
                    <a style="cursor:pointer" class="dropdown-item languages text-center" data-lang="gr"> <span
                            class="fi fi-gr fig"></span> ελληνικά </a>
                </div>
            </div>
        </div>
    </div>
    <form id="Weighted-Mean">
        <div class="col-12 text-center" id="input-buttons" style="margin-top:50px">

            <button type="button" id="spectroscopicinput-btn" class="btn btn-primary"
                data-translate="Spectroscopic input">Spectroscopic input</button>
            <button type="button" id="manualinput-btn" class="btn btn-secondary" data-translate="Manual input">Manual
                input</button>

        </div>

        <div class="row col-8 offset-2 manualinput spectroscopicinput" style="display:none">
            <div class="col row">
                <div class="col-12 ">
                    <button type="button" class="btn btn-success btn-circle" style="border-radius:40%"
                        id="addsample-btn">+</button>
                    <button type="button" class="btn btn-danger btn-circle" style="border-radius:40%"
                        id="removesample-btn">-</button>
					<button type="button" class="btn btn-warning btn-circle" style="border-radius:40%"
                        id="resetsample-btn">X</button>
                </div>
                <div class="form-group col">
                    <label for="Values" data-translate="Values">Values</label>
                    <input type="number" id="val" name="val[]" class="form-control required" tabindex="1">
                </div>
            </div>
            <div class="col row">
                <div class="col-12 ">
                    <h5>&nbsp;</h5>
                </div>
                <div class="form-group col">
                    <label for="Uncertainties" data-translate="Uncertainties">Uncertainties</label>
                    <input type="number" id="unc" name="unc[]" class="form-control required" tabindex="1.5">
                </div>
            </div>
        </div>

        <div class="row col-8 offset-3 manualinput spectroscopicinput" id="calculate-buttons" style="display:none">
            <div class="row col-12">
                <div>
                    <button type="button" id="calculate" class="btn btn-success"
                        data-translate="Calculate">Calculate</button>
                </div>
                <div class="offset-1">
                    <input type="reset" id="reset-btn" value="Reset" class="btn btn-danger" data-translate="Reset">
                </div>
				<div class="offset-1">
                    <input type="reset" id="back-btn" value="Back" class="btn btn-warning" data-translate="Back">
                </div>
            </div>
            <div class="col-12 form-group" id="result-tab" style="display:none">
                <br>
                <label for="result" data-translate="Result:">Result:</label>
                <div id="result" class="alert alert-success"></div>
            </div>
        </div>
    </form>

    <div class="row col-12"
        style="position:fixed; bottom:0px; text-align: left; width:100%; background:white; height: 70px">
        <div class="col-10">
            <small class="form-text text-muted"> &copy; 2021. This work is licensed under a <a rel="license"
                    href="https://creativecommons.org/publicdomain/zero/1.0/">CC0 1.0 license</a>. <br><span>Created by
                    G. Skarakis and A. Kanellakopoulos</span><br>
                Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a
                    href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></small>
        </div>
        <div class="col-2">
            <a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/"><img
                    alt="Creative Commons Public Domain Dedication" style="border-width:0"
                    src="https://licensebuttons.net/l/zero/1.0/88x31.png" /></a>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            var lang = 'eng'; var myChart = null;

            function t(value) {
                switch (lang) {
                    case 'fr':
                        if (french[value]) {
                            return french[value];
                        }
                    case 'de':
                        if (german[value]) {
                            return german[value];
                        }
                    case 'gr':
                        if (greek[value]) {
                            return greek[value];
                        }
                    case 'es':
                        if (spanish[value]) {
                            return spanish[value];
                        }
                    case 'pt':
                        if (portuguese[value]) {
                            return portuguese[value];
                        }
                    default:
                        return value;
                }
            }

            function translate() {
                $('*[data-translate]').each(function () {
                    let translation = t($(this).data('translate'));
                    if ($(this).is("input")) {
                        $(this).val(translation);
                    } else {
                        $(this).html(translation);
                    }
                });
                $('.translatable').hide();
                $('.translatable.translate-' + lang).show();
            }

            if (typeof (Storage) !== "undefined") {
                let storedlang = localStorage.getItem("language");
                if (storedlang) {
                    lang = storedlang;
                }
            }
            translate();

            $('.languages').on('click', function () {
                lang = $(this).data('lang');
                translate();
                if (typeof (Storage) !== "undefined") {
                    localStorage.setItem("language", lang);
                }
            })

            var inputtype = null;
            $('#manualinput-btn').on('click', function () {
                inputtype = 'manual';
                $('#input-buttons').hide();
                $('.manualinput').show();
                $('#result-tab').hide();

                $("input[name='unc[]']").css("cursor", "").prop('disabled', false);
            })

            $('#spectroscopicinput-btn').on('click', function () {
                inputtype = 'spectroscopic';
                $('#input-buttons').hide();
                $('.spectroscopicinput').show();
                $('#result-tab').hide();

                $("input[name='unc[]']").css("cursor", "not-allowed").prop('disabled', true);
            })

            $('#addsample-btn').on('click', function () {
                $("input[name='val[]']").last().after('<input type="number" name="val[]" class="form-control required" tabindex="' + ($("input[name='val[]']").length + 1) + '">');
                if (inputtype == 'spectroscopic') {
                    $("input[name='unc[]']").last().after('<input type="number" name="unc[]" disabled="true" style="cursor:not-allowed" class="form-control" tabindex="' + ($("input[name='unc[]']").length + 1) + '.5">');
                } else {
                    $("input[name='unc[]']").last().after('<input type="number" name="unc[]" class="form-control required" tabindex="' + ($("input[name='unc[]']").length + 1) + '.5">');
                }
            })

            $('#removesample-btn').on('click', function () {
                if ($("input[name='val[]']").length == 1) {
                    return false;
                }
                $("input[name='val[]']").last().remove();
                $("input[name='unc[]']").last().remove();
            })
			
			$('#resetsample-btn').on('click', function () {
                while ($("input[name='val[]']").length > 1) {
                    $("input[name='val[]']").last().remove();
					$("input[name='unc[]']").last().remove();
                }
            })

            $('#reset-btn').on('click', function () {
                $('#result-tab').hide();
            })
			
			$('#back-btn').on('click', function () {
				$('#resetsample-btn').trigger('click')
                $('#result-tab').hide();
                $('.manualinput').hide();
                $('.spectroscopicinput').hide();
                $('#input-buttons').show();
            })

            $('#calculate').on('click', async function (event, arg1) {

                var result = null;
                var invalidvalues = [];

                var valAr = $("input[name='val[]']").map(function () { return parseFloat($(this).val()); }).get().filter((value, index) => {
                    if (!value && value != 0) {
                        invalidvalues.push(index);
                        return false;
                    }
                    return true;
                });
                var uncAr;
                if (inputtype == 'spectroscopic') {
                    $("input[name='unc[]']").val('');
                    
                    let invalidValueCounter = 0;
                    uncAr = valAr.map((value, index) => {
                        while (invalidvalues.includes(index + invalidValueCounter)) {
                            invalidValueCounter++;
                        }
                        let sqrt = Math.sqrt(value)
                        $("input[name='unc[]']").eq(index + invalidValueCounter).val(sqrt);

                        return sqrt;
                    })
                } else {
                    uncAr = $("input[name='unc[]']").map(function () { return parseFloat($(this).val()); }).get().filter((unc, index) => !invalidvalues.includes(index));
                }

                var numeratorMean = 0.
                var denominatorMean = 0.
                var numeratorSigmaScat = 0.

                // console.log(valAr);
                // console.log(uncAr);

                for (var i in valAr) {
                    if (!uncAr[i]) {
                        alert(t('Empty field or zero value for uncertianty is not allowed'));
                        return false;
                    }

                    numeratorMean += valAr[i] / Math.pow(uncAr[i], 2)
                    denominatorMean += 1 / Math.pow(uncAr[i], 2)
                }

                var meanWeight = numeratorMean / denominatorMean;
                var sigmaStatSq = 1 / denominatorMean;

                for (var i in valAr) {
                    numeratorSigmaScat += Math.pow((valAr[i] - meanWeight) / uncAr[i], 2)
                }

                var sigmaScatSq = numeratorSigmaScat / ((valAr.length - 1) * denominatorMean);

                if (sigmaStatSq > sigmaScatSq) {
                    var meanWeightSigma = Math.pow(sigmaStatSq, 0.5)
                } else {
                    var meanWeightSigma = Math.pow(sigmaScatSq, 0.5)
                }

                result = meanWeight + ' &pm; ' + meanWeightSigma;

                $('#result').html('&lt;x&gt; = ' + result);
                $('#result-tab').show();

            })
        })
    </script>
</body>

</html>